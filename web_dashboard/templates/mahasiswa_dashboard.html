{% extends "base.html" %}

{% block title %}Mahasiswa Dashboard - Academic Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Student Dashboard</h2>

        {# Inject current user object for client-side JS #}
        <script id="current-user-json" type="application/json">
  {{ user | default({}) | tojson | safe }}
</script>

<script>
  // Parse JSON safely from the dedicated script tag
  try {
    const currentUserText = document.getElementById('current-user-json')?.textContent || '{}';
    window.currentUserGlobal = JSON.parse(currentUserText);
  } catch (e) {
    console.error('Gagal parse currentUser JSON:', e);
    window.currentUserGlobal = {};
  }
  console.log("Injected current user (dashboard):", window.currentUserGlobal);
</script>

        <div class="card mb-4">
            <div class="card-header">
                <h4>Biodata Mahasiswa</h4>
            </div>
            <div class="card-body">
                <p><strong>Username:</strong> {{ user.username }}</p>
                <p><strong>NIM:</strong> {{ user.nim }}</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h4>Kartu Rencana Studi (KRS)</h4>
            </div>
            <div class="card-body">
                {% if krs_data %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Semester</th>
                                    <th>Status</th>
                                    <th>Jumlah MK</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for krs in krs_data %}
                                <tr>
                                    <td>{{ krs.semester }}</td>
                                    <td><span class="badge bg-{{ 'success' if krs.status == 'APPROVED' else 'warning' }}">{{ krs.status }}</span></td>
                                    <td>{{ krs.courses|length }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% for krs in krs_data %}
                    <div class="mt-3">
                        <h5>KRS - {{ krs.semester }} (Status: {{ krs.status }})</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Kode MK</th>
                                    <th>Nama MK</th>
                                    <th>SKS</th>
                                    <th>Hari</th>
                                    <th>Jam</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in krs.courses %}
                                <tr>
                                    <td>{{ course.kode }}</td>
                                    <td>{{ course.nama }}</td>
                                    <td>{{ course.sks }}</td>
                                    <td>{{ course.hari }}</td>
                                    <td>
                                        {% if course.jam_mulai and course.jam_selesai %}
                                            {% if course.jam_mulai.strftime %}
                                                {{ course.jam_mulai.strftime('%H:%M') }} - {{ course.jam_selesai.strftime('%H:%M') }}
                                            {% else %}
                                                {{ course.jam_mulai }} - {{ course.jam_selesai }}
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>Tidak ada data KRS tersedia.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h4>Jadwal Kuliah</h4>
            </div>
            <div class="card-body">
                {% if schedule_data %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                <th>Mata Kuliah</th>
                                <th>Dosen</th>
                                <th>Hari</th>
                                <th>Jam</th>
                                <th>Ruang</th>
                                <th>Kelas</th>
                            </tr>
                            </thead>
                            <tbody>
                                {% for schedule in schedule_data %}
                                <tr>
                                    <td>{{ schedule.kode_mk }}</td>
                                    <td>
                                        {# Get the lecturer name from the dosen relationship #}
                                        {% if schedule.dosen %}
                                            {{ schedule.dosen.nama }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ schedule.hari }}</td>
                                    <td>
                                        {% if schedule.jam_mulai and schedule.jam_selesai %}
                                            {% if schedule.jam_mulai.strftime %}
                                                {{ schedule.jam_mulai.strftime('%H:%M') }} - {{ schedule.jam_selesai.strftime('%H:%M') }}
                                            {% else %}
                                                {{ schedule.jam_mulai }} - {{ schedule.jam_selesai }}
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {# Get the room name from the ruang relationship #}
                                        {% if schedule.ruang %}
                                            {{ schedule.ruang.nama }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ schedule.kelas if schedule.kelas else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p>Tidak ada jadwal kuliah tersedia.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h4>Nilai & Transkrip</h4>
            </div>
            <div class="card-body">
                <p>Informasi nilai, IPK, dan transkrip akademik</p>
                <div class="d-grid gap-2">
                    <a href="/dashboard/mahasiswa/grades" class="btn btn-primary">
                        <i class="fas fa-file-alt me-1"></i> Lihat Nilai
                    </a>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#qrScannerModal">
                        <i class="fas fa-qrcode me-1"></i> Presensi (Scan QR)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4>Ringkasan Akademik</h4>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="text-primary"><i class="fas fa-calculator me-2"></i>IPK Terkini</h5>
                                <h3 id="ipkValue">-</h3>
                                <p class="text-muted">Indeks Prestasi Kumulatif</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="text-success"><i class="fas fa-graduation-cap me-2"></i>Total SKS</h5>
                                <h3 id="totalSks">-</h3>
                                <p class="text-muted">Satuan Kredit Semester</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="text-warning"><i class="fas fa-book me-2"></i>Jumlah MK</h5>
                                <h3 id="jumlahMk">-</h3>
                                <p class="text-muted">Mata Kuliah Lulus</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4>Informasi Pembayaran SPP</h4>
            </div>
            <div class="card-body">
                {% if billing_data %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Semester</th>
                                <th>Total Tagihan</th>
                                <th>Sudah Dibayar</th>
                                <th>Sisa Tagihan</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for billing in billing_data %}
                            <tr>
                                <td>{{ billing.semester }}</td>
                                <td>Rp {{ "{:,}".format(billing.total_amount) }}</td>
                                <td>Rp {{ "{:,}".format(billing.paid_amount) }}</td>
                                <td>Rp {{ "{:,}".format(billing.remaining) }}</td>
                                <td>
                                    {% if billing.status == 'paid' %}
                                        <span class="badge bg-success">{{ billing.status }}</span>
                                    {% elif billing.status == 'partial' %}
                                        <span class="badge bg-warning">{{ billing.status }}</span>
                                    {% elif billing.status == 'overdue' %}
                                        <span class="badge bg-danger">{{ billing.status }}</span>
                                    {% elif billing.status == 'unpaid' %}
                                        <span class="badge bg-secondary">{{ billing.status }}</span>
                                    {% else %}
                                        <span class="badge bg-info">{{ billing.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p>Belum ada tagihan SPP.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div class="modal fade" id="qrScannerModal" tabindex="-1" aria-labelledby="qrScannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrScannerModalLabel">Presensi (Scan QR)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="scanner-container">
                    <div id="qr-reader" style="width: 100%;"></div>
                    <div id="qr-reader-results" class="mt-2"></div>
                    <div id="scanner-status" class="mt-2 text-center">
                        <p class="text-info">Arahkan kamera ke QR Code presensi</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
    // Load academic summary with server-side provided data when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Update the IPK value with server-provided data
        const ipkValue = {{ ipk }};
        if (ipkValue !== undefined) {
            document.getElementById('ipkValue').textContent = ipkValue.toFixed(2);
        } else {
            document.getElementById('ipkValue').textContent = '-';
        }

        // Update the total SKS value with server-provided data
        const totalSks = {{ total_sks }};
        if (totalSks !== undefined) {
            document.getElementById('totalSks').textContent = totalSks;
        } else {
            document.getElementById('totalSks').textContent = '-';
        }

        // Update the jumlah MK value with server-provided data
        const jumlahMk = {{ jumlah_mk }};
        if (jumlahMk !== undefined) {
            document.getElementById('jumlahMk').textContent = jumlahMk;
        } else {
            document.getElementById('jumlahMk').textContent = '-';
        }
    });

    let html5QrcodeScanner = null;

    // Modal opened
    document.getElementById('qrScannerModal').addEventListener('shown.bs.modal', function () {
        initializeQRScanner();
    });

    // Modal closed
    document.getElementById('qrScannerModal').addEventListener('hidden.bs.modal', function () {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().catch(() => {});
            html5QrcodeScanner = null;
        }
    });

    function initializeQRScanner() {
        const currentUser = window.currentUserGlobal || {};
        console.log('currentUser in QR scanner:', currentUser);

        const nim = currentUser.nim;
        if (!nim) {
            document.getElementById('scanner-status').innerHTML =
                '<p class="text-danger">NIM tidak ditemukan. Silakan login ulang.</p>';
            return;
        }

        let token = currentUser.token || '';
        if (token && !token.startsWith('Bearer ')) {
            token = 'Bearer ' + token;
        }

        document.getElementById('scanner-status').innerHTML =
            '<p class="text-info">Mengaktifkan kamera...</p>';

        html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader",
            {
                fps: 10,
                qrbox: 250
            },
            false
        );

        html5QrcodeScanner.render(
            (decodedText) => {
                // ðŸ”´ decodedText = isi QR CODE
                html5QrcodeScanner.clear();

                document.getElementById('scanner-status').innerHTML =
                    '<p class="text-info">Memproses presensi...</p>';

                fetch('/api/attendance/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        qr_token: decodedText, // âœ… FIX
                        nim: nim
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('scanner-status').innerHTML =
                            '<p class="text-success">Presensi berhasil âœ…</p>';
                    } else {
                        document.getElementById('scanner-status').innerHTML =
                            `<p class="text-danger">Gagal: ${data.detail || data.message}</p>`;
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('scanner-status').innerHTML =
                        '<p class="text-danger">Gagal mengirim data ke server</p>';
                });
            },
            () => {} // ignore scan failure
        );
    }
</script>
{% endblock %}